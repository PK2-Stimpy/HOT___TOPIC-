package me.ionar.salhack.module.exploit;

import java.util.ArrayList;
import java.util.List;

import me.ionar.salhack.events.network.EventNetworkPacketEvent;
import me.ionar.salhack.events.render.RenderEvent;
import me.ionar.salhack.module.Module;
import me.ionar.salhack.module.Value;
import me.ionar.salhack.util.render.RenderUtil;
import me.zero.alpine.fork.listener.EventHandler;
import me.zero.alpine.fork.listener.Listener;
import net.minecraft.client.renderer.culling.Frustum;
import net.minecraft.client.renderer.culling.ICamera;
import net.minecraft.network.play.server.SPacketChunkData;
import net.minecraft.util.math.AxisAlignedBB;

public class NewChunksModule extends Module
{
    public Value<Boolean> Render = new Value<Boolean>("Render", new String[]
    { "R" }, "Renders the new chunks in the world", true);
    private ICamera frustum = new Frustum();

    private List<ChunkData> chunkDataList = new ArrayList<>();

    public NewChunksModule()
    {
        super("NewChunks", new String[]
        { "ChunkGen" }, "Highlights newly generated chunks", "NONE", -1, ModuleType.EXPLOIT);
    }

    @EventHandler
    private Listener<EventNetworkPacketEvent> PacketEvent = new Listener<>(p_Event ->
    {
        if (p_Event.getPacket() instanceof SPacketChunkData)
        {
            final SPacketChunkData packet = (SPacketChunkData) p_Event.getPacket();
            if (!packet.isFullChunk())
            {
                final ChunkData chunk = new ChunkData(packet.getChunkX() * 16, packet.getChunkZ() * 16);

                if (!this.chunkDataList.contains(chunk))
                {
                    this.chunkDataList.add(chunk);
                }
            }
        }
    });

    @EventHandler
    private Listener<RenderEvent> OnRenderEvent = new Listener<>(p_Event ->
    {
        if (!Render.getValue())
            return;

        if (mc.getRenderManager() == null)
            return;
        
        for (ChunkData chunkData : new ArrayList<ChunkData>(this.chunkDataList))
        {
            if (chunkData != null)
            {
                this.frustum.setPosition(mc.getRenderViewEntity().posX, mc.getRenderViewEntity().posY, mc.getRenderViewEntity().posZ);

                final AxisAlignedBB bb = new AxisAlignedBB(chunkData.x, 0, chunkData.z, chunkData.x + 16, 1, chunkData.z + 16);

                if (frustum.isBoundingBoxInFrustum(bb))
                {
                    RenderUtil.drawPlane(chunkData.x - mc.getRenderManager().viewerPosX, -mc.getRenderManager().viewerPosY,
                            chunkData.z - mc.getRenderManager().viewerPosZ, new AxisAlignedBB(0, 0, 0, 16, 1, 16), 1, 0xFF9900EE);
                }
            }
        }
    });

    public static class ChunkData
    {
        private int x;
        private int z;

        public ChunkData(int x, int z)
        {
            this.x = x;
            this.z = z;
        }

        public int getX()
        {
            return x;
        }

        public void setX(int x)
        {
            this.x = x;
        }

        public int getZ()
        {
            return z;
        }

        public void setZ(int z)
        {
            this.z = z;
        }
    }
}
